\subsection{Introduction}\label{introduction}

Agent-based models linking individual behavior to population dynamics are essential for understanding human security and social equity issues within human systems \cite{germann2022assessing, ozik2021population, urbanpop-AG-2023}. A current challenge for these models is to more directly account for population heterogeneity \cite{BRaVE_DOE_2022}, which relates to factors including socio-demographic characteristics, patterns of life, and critical infrastructure. The UrbanPop spatial microsimulation framework developed by Oak Ridge National Laboratory (ORNL) presents a means to integrate these factors by combining attribute-rich and customizable synthetic populations generated from the American Community Survey (ACS) and its Public-Use Microdata Sample (PUMS) with real-world data on housing, transportation, and points of interest (POIs) \cite{urbanpop-AG-2023}. Central to UrbanPop's capabilities is Likeness, a Python toolkit that combines population synthesis, spatial network modeling, and activity allocation \cite{likeness-scipy-paper-2022, likeness-scipy-poster-2022}. Likeness supports the creation of more dynamic agent-based models that can be applied to topics ranging from epidemiology to environmental hazards. 

Foundational examples produced for Likeness have explored travel routing from home to anchor activities (e.g., work, school), POI occupancy characteristics \cite{likeness-scipy-paper-2022, likeness-scipy-poster-2022}, as well as routing incidental travel from anchor to non-anchor activities (e.g., social, errands, health) \cite{likeness_aag_2023}. This paper builds from these foundational examples to
discuss scaling our methods to larger areas of interest, as well as examines the performance of our activity allocation model relative to real-world POI demographics from digital trace data.

\subsection{Expansion and Scaling of Likeness Capabilities}\label{section:likeness-expansion-scaling}

\input figures/ecosystem.tex

In step with the creation of foundational examples for Likeness, we have developed an integrated workflow that scales the ecosystem (Figure~\ref{fig:ecosystem}) to support microsimulation for any metropolitan statistical area (MSA) in the United States.

Figure~\ref{fig:parse-to-attribution} outlines the procedure for agent generation at the MSA level. As discussed in \cite{likeness-scipy-paper-2022}, the \texttt{livelike.acs.puma} class is the core object for residential population synthesis, which stores all census microdata and geographic (e.g., block group, tract) model constraints to support spatial allocation for a single Public-Use Microdata Area (PUMA) in the United States. Residential synthetic populations for MSAs are generated as collections of PUMAs, which are parsed automatically by combining U.S. Census metropolitan/micropolitan delineation files\footnote{https://www.census.gov/geographies/reference-files/time-series/demo/metro-micro/delineation-files.html} with the Census 2010 PUMA-to-tract relationship file\footnote{https://www.census.gov/programs-surveys/geography/technical-documentation/records-layout/2010-tract-to-puma-record-layout.html}. PUMAs parsed for the target MSA are converted into \texttt{livelike.acs.puma} objects in bulk via \texttt{livelike.multi.make\_pumas()}, which accepts the PUMA FIPS codes in list form, along with the target ACS year, and uses this information to gather the relevant ACS Summary File (SF) constraints for spatial allocation. Spatial allocation is subsequently handled with parallelization using Python's built-in \texttt{multiprocessing} utility, which is supported by both packages Likeness offers for Penalized Maximum-Entropy Dasymetric Modeling (P-MEDM) \cite{nagle2014dasymetric}: \texttt{pymedm} (bleeding-edge, Python-native version, based on \texttt{jaxopt} \cite{jaxopt_implicit_diff}) and \texttt{pmedm\_legacy} (stable bridge to original R/C++ routine\footnote{https://bitbucket.org/nnnagle/pmedmrcpp} via \texttt{rpy2}). As demonstrated in \cite{likeness-scipy-paper-2022} and \cite{likeness-scipy-poster-2022}, the population synthesis routine also collects diagnostics on each P-MEDM solution's degree of conformity to the published 90\% Margins of Error (MOEs) reported in the ACS SF (``MOE Fit Rate''), available in both \texttt{pymedm} and \texttt{pmedm\_legacy}. 

Likeness generates agents for microsimulation in a way that provides realistic home (origin) locations from which to allocate essential activities on transportation networks. Our initial approach, based on census block-level housing density \cite{likeness-scipy-paper-2022, likeness-scipy-poster-2022}, is now implemented in \texttt{livelike} as a housing universe generation procedure. Additionally, we are actively developing a method (demonstrated in \nameref{section:LCFL}) that enhances this capability by matching synthesized households to residential locations. These matches are performed via building footprint data by conflating housing type labels between synthetic households (linked from PUMS) and structures including single-family and multi-family dwellings. 

\input figures/parse-to-attribution

Agent generation at residential locations via \texttt{livelike} provides origin points for simulating travel to essential activities. 
The next stage in the workflow employs network analysis to model the cost of travel to these activities \cite{OpenStreetMap, osmnx_CEUS_2017, foti_generalized_2012} and allocate agents to POIs accordingly based on mathematical programming routines \cite{mitchell_pulp_2011, santos_mixed_2020, lougee_coin_2003, forrest_coinorcbc_2023}. In our first iteration of Likeness, both these tasks were accomplished within \texttt{actlike}. However, it was decided that the network modeling piece was specialized enough to be split from the \texttt{actlike} package, which led to the creation of \texttt{movelike}. With a push for varied modes of network traversal, three new modes of travel can now be modeled: walking, biking, public transit. However, modeling travel behavior via public transportation is less straightforward than for driving, biking, and walking networks due to stricter network topology, including factors like connectivity and directionality of routes. We have taken our first foray into modeling more realistic public transit behavior within \texttt{movelike} through the incorporation of the General Transit Feed Specification (GTFS)\footnote{https://gtfs.org/}. GTFS is a data specification that stipulates the required files, along with their structure and format\footnote{https://gtfs.org/schedule/reference/\#dataset-files}, for publishing, ingesting, and utilizing public transit datasets. The GTFS datasets can be obtained via services such as \textit{TransitFeeds}\footnote{https://transitfeeds.com/} and \textit{The Mobility Database Catalogs}\footnote{https://github.com/MobilityData/mobility-database-catalogs}. In our current iteration we utilize GTFS data feeds to implement a pseudo-transit network space by which agents can engage in limited traversal. This is accomplished through a mask of \textit{OpenStreetMap}\footnote{https://www.openstreetmap.org/} (OSM) street segments known to be associated with bus routes. The OSM network is masked by passing a (multi)polygon feature of buffered and unioned bus routes within the study area into \texttt{osmnx} \cite{osmnx_CEUS_2017}. This method demonstrates progression in representing public transit but certainly has room for improvement, which will be discussed in \nameref{section:dev-roadmap}.

Finally -- and at the heart of it all -- expansion and scaling of the Likeness ecosystem led to the development of a new package for common utilities, \texttt{likeness-vitals}, which provides support for monitoring and timing processes, data manipulation, shared spatial functionality, and Census API access.

\subsection{Integrated Demonstration: Leon County, Florida} \label{section:LCFL}

Following the workflow described in Section~\nameref{section:likeness-expansion-scaling}, we demonstrate the current capabilities of Likeness and validate our activity allocation routine for Leon County, Florida. Leon County, whose primary city is Tallahassee, features a population of just under 300,000 residents, a compact urban footprint, and a diverse array of transportation modes (driving, transit, bike, walking). Our mobility validation exercise is based on grocery store visits from simulated home locations. Grocery stores provide a useful test case because they are both catchments for the general population and points of access to vital services including food and healthcare. We obtained grocery store visits from Foursquare's Research Visits feed, which provides footfall data attributed by demographic cohort (gender by age) for a variety of point of interest (POI) types\footnote{https://location.foursquare.com/places/docs/how-does-places-work}\textsuperscript{,}\footnote{https://location.foursquare.com/visits/docs/research-feed-schema}. 

We first simulated a single synthetic population for the Tallahassee Core-Based Statistical Area (CBSA), based on constraining variables including technical characteristics linked to sampling universe totals (i.e., population, housing units, households), as well as descriptive factors including demographics, socioeconomic status, housing, mobility, and worker and student characteristics. For the remainder of the analysis, we focused on Leon County alone, removing large outlying areas of the MSA (PUMA \texttt{1206300}). Agents\footnote{Agents less than 20 years old were not include in the Foursquare POI data, thus they are excluded from our analysis.} were generated on the Federal Emergency Management Agency's (FEMA) open USA Structures database \cite{yang2018building, usa_struct_2022}, based on the sampling of synthetic households to single-family residential, multi-family residential, mobile homes, group quarters housing types.

We used employment and travel mode characteristics linked to agents to determine transportation networks used to access grocery POIs from home locations. Agents labeled as `employed' possess an associated flag that identifies reported commute mode that can take the following values: `car\_truck\_van', `bicycle', `walked', `wfh', `public\_transportation', `other', and `motorcycle'. Because detailed travel modes are unavailable for agents that are not employed (e.g., retired, active military), we rely on private (i.e., household-level) vehicle ownership instead.

\input figures/mode_assign_workflow

Travel modes assigned to each agent were conflated with four transportation network types: `walked', `bicycle', `public\_transportation', and `drive'. We supported this process by developing a decision tree, visualized in Figure~\ref{fig:mode_assign_workflow}, through which we assume:

\begin{itemize}
    \item Employed agents will use the transportation network that best matches their commute mode to access grocery POIs.
    \item Agents that are not employed will use a privately-owned vehicle, and thus the `drive' network, to access grocery POIs when available.
    \item Agents that are not employed and lack a privately-owned vehicle will use public transportation if they are located in a block group that is served by Tallahassee's bus network (StarMetro) and opt to walk otherwise. 
\end{itemize}

%The first step in the travel mode decision process is to check for an agent's positive employments status. If the agent is employed, we next isolate the reported commute mode. If the commute mode is either `walked' or `bicycle', we assign those travel modes. If the mode is either `car\_truck\_van' or `motorcycle', we label the agent's mode as `drive'. For agent's whose reported commute mode is `public\_transportation' we determine the existence of a bus route in their home block route; if a route passes through the block group we assign `public\_transportation', otherwise their mode is labeled `walk'. For the `wfh' and `other' modes, we assign the majority non-driving commute mode, with the extra check for presence of a bus route if that mode is `public\_transportation'. Should the agent not be a member of the workforce, we rely of personal vehicle ownership to determine travel mode. If the agent owns a personal vehicle the `drive' label is applied, otherwise we default to the block group majority travel mode as previously described.

As demonstrated in Table~\ref{tab:agents_counts_travel_mode}, the `drive' network supports the overwhelming majority of travel to grocery POIs in Leon County, followed by walking, public transportation, and bicycle access. 

\input tables/agents_counts_travel_mode

Figure~\ref{fig:2x2_agents_hex} shows that Leon County's agent population is distributed unevenly relative to assigned travel modes. Because Leon County's infrastructure primarily supports travel by car, agents who drive are distributed closest to the area's general population density. The spatial distribution of agents who travel by walking also tends to follow Leon County's settlement patterns, though in more limited numbers than for those who drive. Agents using public transport, meanwhile, are largely present in and near the center of the county, roughy occupying denser urban areas where StarMetro service is available. Bicyclists are distributed similarly to bus takers, but with several individual clusters associated with smaller outlying towns and settlements. 

% where Tallahassee's core and populated periphery are clearly delineated by the Apalachicola National Forest in the southwest portion of Leon County, the Plank Road State Forest in the southeast, and the Tall Timbers Research Institute to the north along the Georgia border. The distribution of the walking population stands out as seemingly inconsistent with modern day lived experience: people don't usually walk for hours to get to the grocery store. This can be attributed to our assignment process (Figure~\ref{fig:mode_assign_workflow}) where agents were labeled as walkers if the decision tree led to an evaluation of transit presence and it wasn't available, in which case they were labeled as walkers by default. Future iterations will improve this decision with a more refined decision procedure.

\input figures/2x2_agents_hex

Grocery store POIs with medium to high visit confidence (at least 30 device visits per month, $n$ = 53) were obtained from Foursquare for Leon County in January 2023. Destination capacities were estimated based on visit counts weighted by representativeness of the demographic cohort within the state's 2010 Census population\footnote{https://location.foursquare.com/visits/docs/foursquare-data-normalization}. Destination capacities were estimated by the daily average (mean) for each POI during the collection month (01/2023).

After travel mode was assigned, four network cost matrices were calculated from origins (agents' residential locations) to destination POIs in \texttt{movelike}. Agents were then allocated to a single probable destination with the \texttt{actlike.ActivityAllocation} routine, which solves a modified Transportation Problem \cite{tp_miller_gc__2015}, where destination POI capacities are scaled \cite{lovelace_truncate_2013} by the proportion of assigned travel mode for each scenario. All models were run consecutively on two machines for benchmarking purposes. These were:

\begin{itemize}
    \item A personal laptop (macOS) with a 2.3 GHz Quad-core Intel Core i7 processor (32 GB RAM).
    \item A virtual machine (Ubuntu) with a 2.8 GHz 22-core Intel(R) Xeon(R) processor (86 GB RAM).
\end{itemize}
    
The large disparity in problem size seen in Table~\ref{tab:agents_counts_travel_mode} is even more pronounced in solution runtimes, shown in Table~\ref{tab:allocation_solution_runtime}, with optimal solutions for non-drive models being found in a maximum time of just over 1 minute on both machines and the drive model taking more than 17 and 8 hours to solve on the macOS and Ubuntu machines, respectively. Considering the solution time for the drive scenario, there is clearly a need for a more effective solution technique, which will be further discussed in \nameref{section:dev-roadmap}.

\input tables/allocation_solution_runtime

To enable comparison with the results of \cite{likeness-scipy-paper-2022} and \cite{urbanpop-AG-2023}, which focused on anchor activities (work/school travel), we validated grocery store visits using Canonical Correlation Analysis (CCA) on the between-destination (relative prevalence) and within-destination (compositional) characteristics of each POI by demographic group. Both CCA runs were generated from tabulated counts of trips from the observed and synthetic datasets, their key difference being the method of standardization (column-wise for between-destination, row-wise for within-destination). We used the CCA coefficient of determination ($R^2$) to measure associations between synthetic and observed results. 

We also investigated local (POI-specific) within-destination correspondence in compositional characteristics based on gender/age cohorts in five-year intervals (until age 70, which is top-coded), in this case based on Spearman rank correlation due to the relatively small number of demographic cohorts ($n$ = 11).

\subsection{Results}\label{section:results}

\subsubsection{Demographic Validation}

\input tables/demographic_validation.tex

\input figures/local_demographic_validation.tex

Each of the three P-MEDM runs (one for each PUMA in the Tallahassee CBSA) resulted in a synthetic reconstruction of the ACS 90\% MOEs that conformed within 99\% of the published MOEs from the ACS SF (Table~\ref{tab:demographic-validation}. Mapped to Leon County block groups (Figure~\ref{fig:local-demographic-validation}), MOE Fit Rates were somewhat lower but still conform within 90\% of the ACS SF MOEs. In particular, we observed diminished performance in areas with large group quarters populations (e.g., college dormitories, prisons), as well as more sparsely populated rural and peri-urban portions of Leon County. 

\subsubsection{Mobility Validation}

\input figures/local_win_cca.tex

Our mobility simulation more realistically recreated between-destination demographics ($R^2$ = 0.74) than within-destination demographics ($R^2$ = 0.41) (Table~\ref{tab:demographic-validation}). Inspecting the local within-destination scores, mapped in Figure~\ref{fig:local-win-cca}, we observed generally greater correspondence between synthetic and observed POI demographics near Tallahassee's downtown core, Florida State University, and Florida A\&M University, with diminished performance in suburban and outlying areas of Leon County. 

\subsection{Limitations}\label{section:limitations}

We found that overall, Likeness approximates travel to non-anchor (grocery store) POIs modestly well. However, contrasted with anchor activities (work/school) demonstrated in \cite{likeness-scipy-paper-2022}, non-anchor activities, like grocery store visits, occur at locations that do not have defined capacities (e.g., employee or enrollment sizes) are a greater challenge to represent realistically. Multiple factors related to data inputs and model assumptions may have confounded our results:

\begin{itemize}
    \item The clearest \textbf{data-specific} challenge is temporal mismatch between the synthetic population (2019) and POI visit data (2023). We have yet to increment our ACS year due to sporadic issues of non-conforming geography between the 2010 PUMAs and 2020 block groups/tracts that we hope to resolve starting with the forthcoming 2022 ACS releases, which will begin to use 2020 PUMAs\footnote{https://www.census.gov/programs-surveys/acs/news/data-releases/2022/release.html}. We were also limited to only one month of POI visit data, but we hope to expand its scope for future validation exercises.
    \item Several large \textbf{model-specific} assumptions were made that could confound our results, particularly that 1) agents simultaneously travel to grocery stores, 2) agents only select one grocery store to visit, using only one mode of travel, and 3) travel to grocery stores only occurs between home and work. These assumptions can be updated by incorporating information from time-use and travel surveys into Likeness, thereby better reflecting the times of day that different demographic cohorts access various activities \cite{macal2018chisim}.
    \item Going forward, we also hope to tighten our assumptions about the feasibility of POI access relative to the various travel modes. For example, in our current assignment process (Figure~\ref{fig:mode_assign_workflow}) agents who we could not label with a defined travel mode were considered walkers as a fallback for unavailability of a bus route in their block group of residence. Future iterations will refine this decision process by considering a distance threshold for agents to be labeled as either walkers or transit users (e.g., walking agents must be located within a reasonable distance of the closest POI, while agents that use bus service should reside near a bus stop, not merely be located in a block group that intersects a bus route). To ensure all agents have at least one feasible POI destination to access, we also plan to incorporate a greater variety of curated locations from ORNL's PlanetSense database \cite{thakur2015planetsense}. 
\end{itemize}


\subsection{Conclusion and Outlook}\label{section:conclusion-outlook}

This paper presented enhancements and scaling for the Likeness spatial microsimulation toolkit -- including implementing batched population synthesis runs and large-scale transportation network generation -- to enable activity modeling with customizable agent populations based on real-world housing stock and transportation infrastructure for any metropolitan statistical area (MSA) in the United States. We demonstrated these capabilities by developing a mobility validation exercise for Leon County, FL. While the results of this initial exercise were only modestly successful, they provide new research questions that we plan to tackle as our workflow develops. 

\subsection{Development Roadmap: 2023 - 2024} \label{section:dev-roadmap}

\begin{itemize}
    \item \textbf{Tooling for custom geographic extents.} The MSA-specific workflow demonstrated in this paper is limited in that it does not support custom geographic extents, limiting analysis, for example, of predominantly rural areas. 
    We are actively developing an approach to create residential synthetic populations for custom areas of interest (AOIs), supported by USA Structures, which will include national-scale coverage. 
    \item \textbf{Open-sourcing core packages.} Though we have yet to meet our goal of open-sourcing the suite of Likeness packages \cite{likeness-scipy-paper-2022}, we are still on track to release the core packages for residential population synthesis, \texttt{pymedm} and \texttt{livelike}, in 2023, with releases of \texttt{movelike} and \texttt{actlike} likely to follow in 2024.
    \item \textbf{Packaging schema.} A further consideration related to open-sourcing is whether we should migrate from a confederated toolkit schema where each module is a semi-independent Python package, as is seen in the modern implementation of PySAL \cite{pysal_GA_2022}, to a single monolithic Python package with submodules. Each schema has benefits and this decision will require much consideration. 
    \item \textbf{Consolidating visualization functionality.} We are in the process of consolidating functionality related to the visualization of input, processing, and results that have been used in an ad-hoc manner in the past. An initial push will be made for the inclusion of ``made-to-order'' population density hexbin plots and network-space allocation routes.
    \item \textbf{Improving mobility modeling.} Realism in mobility modeling is a key area in which we are constantly striving for improvements, specifically transit. As stated previously in \nameref{section:likeness-expansion-scaling}, there is significant potential in exploring further integration of GTFS data for locally-accurate modeling.
    \item \textbf{Optimization bottleneck.} As demonstrated in \nameref{section:results}, there is a clear hit in computational performance and runtime when solving  \texttt{actlike.ActivityAllocation} problems on increasingly larger model instances (e.g., more agents and more POIs). There are two paths to resolving this issue (which may be considered in concert): 1) Reviewing our modified Transportation Problem mixed-integer program (formulated in \cite{likeness-scipy-paper-2022}); and 2) Utilizing a new underlying solver engine, such as HiGHS\footnote{https://highs.dev/} \cite{highs_mpc_2018}.
\end{itemize}

\subsection{Acknowledgements}

The authors would like to thank Ty Frazier for his contributions to scoping the incorporation of General Transit Feed Specification (GTFS) data during an earlier phase of this project.

Notice: Research reported in this publication was supported by the National Center For Advancing Translational Sciences of the National Institutes of Health under Award Number UL1-TR001409, KL2-TR001432 \& TL1-TR001431. The content is solely the responsibility of the authors and does not necessarily represent the official views of the National Institutes of Health.

This manuscript has been authored by UT-Battelle, LLC under Contract No. DE-AC05-00OR22725 with the U.S. Department of Energy. The United States Government retains and the publisher, by accepting the article for publication, acknowledges that the United States Government retains a non-exclusive, paid-up, irrevocable, world-wide license to publish or reproduce the published form of this manuscript, or allow others to do so, for United States Government purposes. The Department of Energy will provide public access to these results of federally sponsored research in accordance with the DOE Public Access Plan (http://energy.gov/downloads/doe-publicaccess-plan).

% This manuscript has been authored by UT-Battelle, LLC, under contract DE-AC05-00OR22725 with the US Department of Energy (DOE). The US government retains and the publisher, by accepting the article for publication, acknowledges that the US government retains a nonexclusive, paid-up, irrevocable, worldwide license to publish or reproduce the published form of this manuscript, or allow others to do so, for US government purposes. DOE will provide public access to these results of federally sponsored research in accordance with the DOE Public Access Plan (http://energy.gov/downloads/doe-public-access-plan).

% bibliography
\bibliographystyle{ieeetr}
\bibliography{ mybib }

\end{document}